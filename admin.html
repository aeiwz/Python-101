<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DNA Base Game — Admin</title>
  <style>
    :root{ --bg:#0b1020; --card:#111834; --ink:#e9f0ff; --muted:#9fb0d3; --accent:#7dd3fc; --A:#ef4444; --T:#f59e0b; --C:#22c55e; --G:#3b82f6; }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter; background:var(--bg); color:var(--ink)}
    header{display:flex; gap:12px; align-items:center; padding:16px 20px; border-bottom:1px solid #1e2a55; position:sticky; top:0; background:linear-gradient(180deg, rgba(11,16,32,.9), rgba(11,16,32,.7)); backdrop-filter:saturate(120%) blur(6px)}
    h1{font-size:18px; margin:0; letter-spacing:.3px}
    main{padding:18px; max-width:1100px; margin:0 auto}
    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:end; margin:12px 0 20px}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input[type="number"], input[type="text"]{background:#0f1530; color:var(--ink); border:1px solid #2c3768; border-radius:10px; padding:10px 12px; width:160px}
    button{padding:10px 14px; border-radius:10px; border:1px solid #2c3768; background:#14204a; color:var(--ink); cursor:pointer}
    button.primary{border-color:#3a4aa0; background:#1a2b66}
    button.warn{border-color:#7a2b2b; background:#401a1a}
    .hint{color:var(--muted); font-size:12px}
    .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:12px}
    .card{background:var(--card); border:1px dashed #2b3565; border-radius:16px; padding:14px; position:relative; overflow:hidden}
    .badge{position:absolute; top:10px; right:10px; font-size:11px; color:#a6b7e5; border:1px solid #2e3a72; border-radius:20px; padding:4px 8px}
    .base{font-size:52px; font-weight:800; letter-spacing:2px; margin:10px 0 0}
    .base[data-b="A"]{color:var(--A)} .base[data-b="T"]{color:var(--T)} .base[data-b="C"]{color:var(--C)} .base[data-b="G"]{color:var(--G)}
    .subtitle{color:var(--muted); font-size:12px}
    .id{font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; letter-spacing:.5px; margin-top:8px}
    .foot{margin-top:12px; font-size:11px; color:#9ab3ff}
    table{width:100%; border-collapse:collapse; background:#0f1530; border:1px solid #2c3768; border-radius:12px; overflow:hidden}
    th, td{padding:10px; border-bottom:1px solid #1e2a55; font-size:14px}
    th{color:#c8d5ff; text-align:left; background:#121a3b}
    tr:last-child td{border-bottom:0}
    .pill{display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid #2e3a72}
    @media print{ header, .controls, .no-print{display:none !important} body{background:white; color:black} .grid{grid-template-columns:repeat(4,1fr)} .card{border:1px solid #999; -webkit-print-color-adjust:exact; print-color-adjust:exact} }
  </style>
</head>
<body>
<header>
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 7c4-5 12-5 16 0M4 17c4 5 12 5 16 0" stroke="#7dd3fc" stroke-width="1.6" stroke-linecap="round"/></svg>
  <h1>DNA Base Game — Admin</h1>
</header>
<main>
  <p class="hint">Generate print‑ready cards with balanced A/T/C/G. Manage redemption, export CSV, or reset.</p>

  <div class="controls">
    <div>
      <label for="count">Number of students</label>
      <input type="number" id="count" min="" step="1" value="" />
    </div>
    <div>
      <label for="seed">Seed (optional, reproducible shuffle)</label>
      <input type="text" id="seed" placeholder="e.g. CLASS8-2025" />
    </div>
    <button class="primary" onclick="generate()">Generate cards</button>
    <button onclick="window.print()">Print cards</button>
    <button onclick="exportCSV()">Export CSV</button>
    <button class="warn" onclick="resetAll()">Reset (clear saved)</button>
  </div>

  <div id="summary" class="hint"></div>
  <div id="grid" class="grid" aria-live="polite"></div>

  <h3 class="no-print">Redeem / Check‑in</h3>
  <div class="controls no-print">
    <div>
      <label for="redeemId">Card ID</label>
      <input type="text" id="redeemId" placeholder="e.g. MBDL9K-3A2F" />
    </div>
    <button class="primary" onclick="redeem()">Redeem</button>
    <button onclick="unredeem()">Un‑redeem</button>
  </div>
  <div id="redeemMsg" class="hint"></div>

  <h3 class="no-print">Roster</h3>
  <div id="rosterWrap" class="no-print"></div>

  <h3 class="no-print">Redemption Log</h3>
  <div id="logWrap" class="no-print"></div>
</main>

<script>
  const STORE_KEY = 'dna_game_cards_v1';
  const USED_KEY  = 'dna_game_used_v1';
  let cards = loadJSON(STORE_KEY) || [];
  let used  = loadJSON(USED_KEY)  || {}; // { id: timestamp }

  function loadJSON(key){ try{ return JSON.parse(localStorage.getItem(key) || 'null'); }catch{ return null } }
  function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  function uid(){ const part = () => Math.random().toString(36).slice(2,6).toUpperCase(); return part()+"-"+part(); }
  function mulberry32(a){ return function(){ let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; } }
  function strHash(s){ let h=2166136261; for (let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h*=16777619 } return h>>>0 }
  function shuffled(array, rng=Math.random){ const a = array.slice(); for(let i=a.length-1;i>0;i--){ const j = Math.floor(rng()* (i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

  function generate(){
    const n = Math.max(4, parseInt(document.getElementById('count').value||'40',10));
    const seedStr = document.getElementById('seed').value.trim();
    const rng = seedStr ? mulberry32(strHash(seedStr)) : Math.random;
    const bases = ['A','T','C','G'];
    const list = []; for(let i=0;i<n;i++){ list.push(bases[i%4]); }
    const shuffledBases = shuffled(list, rng);
    cards = Array.from({length:n}, (_,i)=>({ id: uid(), base: shuffledBases[i] }));
    used = {}; saveJSON(STORE_KEY, cards); saveJSON(USED_KEY, used);
    renderCards(); renderRoster(); renderSummary(); renderLog();
  }

  function exportCSV(){
    if(!cards.length){ alert('No cards to export. Click "Generate cards" first.'); return }
    const rows = [['index','id','base','used','used_at']]
      .concat(cards.map((c,i)=>[i+1, c.id, c.base, used[c.id] ? 'YES':'NO', used[c.id] || '' ]));
    const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:'dna_cards.csv'});
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function resetAll(){
    if(!confirm('Clear saved cards and redemption log?')) return;
    cards = []; used = {}; saveJSON(STORE_KEY, cards); saveJSON(USED_KEY, used);
    document.getElementById('grid').innerHTML='';
    document.getElementById('rosterWrap').innerHTML='';
    document.getElementById('summary').textContent='';
    document.getElementById('redeemMsg').textContent='';
    document.getElementById('logWrap').innerHTML='';
  }

  function renderCards(){
    const grid = document.getElementById('grid');
    if(!cards.length){ grid.innerHTML = '<div class="hint">No cards yet. Click <b>Generate cards</b>.</div>'; return }
    const frag = document.createDocumentFragment();
    cards.forEach((c,i)=>{
      const el = document.createElement('div');
      el.className='card';
      el.innerHTML = `
        <span class="badge">#${i+1}</span>
        <div class="subtitle">DNA Base</div>
        <div class="base" data-b="${c.base}">${c.base}</div>
        <div class="id">ID: ${c.id}</div>
        <div class="foot">Give this card to a student ➜ keep the ID safe</div>
      `;
      frag.appendChild(el);
    });
    grid.replaceChildren(frag);
  }

  function renderSummary(){
    const counts = {A:0,T:0,C:0,G:0}; cards.forEach(c=>counts[c.base]++);
    document.getElementById('summary').innerHTML = cards.length
      ? `<b>${cards.length}</b> cards → <span class="pill">A: ${counts.A}</span> <span class="pill">T: ${counts.T}</span> <span class="pill">C: ${counts.C}</span> <span class="pill">G: ${counts.G}</span>`
      : '';
  }

  function renderRoster(){
    if(!cards.length){ document.getElementById('rosterWrap').innerHTML=''; return }
    const rows = cards.map((c,i)=>`<tr><td>${i+1}</td><td><code>${c.id}</code></td><td>${c.base}</td><td>${used[c.id] ? 'YES' : 'NO'}</td><td>${used[c.id] || ''}</td></tr>`).join('');
    document.getElementById('rosterWrap').innerHTML = `
      <div style="overflow:auto">
      <table>
        <thead><tr><th>#</th><th>ID</th><th>Base</th><th>Used?</th><th>Used at</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      </div>`;
  }

  function redeem(){
    const id = (document.getElementById('redeemId').value||'').trim().toUpperCase();
    const msgEl = document.getElementById('redeemMsg');
    if(!id){ msgEl.textContent='Enter a card ID.'; return }
    const found = cards.find(c=>c.id.toUpperCase()===id);
    if(!found){ msgEl.textContent = '❌ ID not found. Check typing.'; return }
    if(used[id]){ msgEl.textContent = `⚠️ Already used at ${used[id]}. Base: ${found.base}`; return }
    const now = new Date().toLocaleString(); used[id] = now; saveJSON(USED_KEY, used);
    msgEl.textContent = `✅ Redeemed. Base: ${found.base} — marked at ${now}`;
    renderRoster(); renderLog(); renderSummary();
  }
  function unredeem(){
    const id = (document.getElementById('redeemId').value||'').trim().toUpperCase();
    const msgEl = document.getElementById('redeemMsg');
    if(!id){ msgEl.textContent='Enter a card ID.'; return }
    if(!used[id]){ msgEl.textContent='ID is not marked as used.'; return }
    delete used[id]; saveJSON(USED_KEY, used); msgEl.textContent='🧽 Cleared redemption for this ID.';
    renderRoster(); renderLog(); renderSummary();
  }

  function renderLog(){
    const entries = Object.entries(used).sort((a,b)=> new Date(b[1]) - new Date(a[1]));
    const wrap = document.getElementById('logWrap');
    if(!entries.length){ wrap.innerHTML = '<div class="hint">No redemptions yet.</div>'; return }
    const rows = entries.map(([id,when])=>{
      const base = (cards.find(c=>c.id===id)||{}).base || '?';
      return `<tr><td><code>${id}</code></td><td>${base}</td><td>${when}</td></tr>`;
    }).join('');
    wrap.innerHTML = `
      <div style="overflow:auto">
      <table>
        <thead><tr><th>ID</th><th>Base</th><th>When</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      </div>`;
  }

  (function boot(){ if(cards.length){ renderCards(); renderRoster(); renderSummary(); renderLog(); } })();
</script>
</body>
</html>